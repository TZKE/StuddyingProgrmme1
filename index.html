<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule Planner Pro</title>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Flatpickr CSS for date picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Firebase JS SDK (Compatibility Build for simplicity, but modular is preferred for new projects) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    /* Custom styles for priority colors */
    .task-priority-high { background-color: #fecaca; } /* Red-100 */
    .task-priority-medium { background-color: #fef3c7; } /* Yellow-100 */
    .task-priority-low { background-color: #d1fae5; } /* Green-100 */

    /* Dark Mode Styles */
    body.dark-mode {
      background-color: #1a202c; /* dark gray */
      color: #e2e8f0; /* light gray text */
    }
    body.dark-mode .bg-white {
      background-color: #2d3748; /* darker gray for cards */
    }
    body.dark-mode .shadow-xl {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }
    body.dark-mode .text-purple-700 {
      color: #9f7aea; /* light purple */
    }
    body.dark-mode .bg-purple-50 {
      background-color: #4a5568; /* darker gray for list items */
    }
    body.dark-mode .border-gray-300 {
      border-color: #4a5568;
    }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    /* Flatpickr Dark Mode Overrides */
    body.dark-mode .flatpickr-calendar {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #e2e8f0;
    }
    body.dark-mode .flatpickr-day.selected, body.dark-mode .flatpickr-day.selected:hover {
      background-color: #9f7aea;
      border-color: #9f7aea;
      color: #fff;
    }
    body.dark-mode .flatpickr-day.today {
      border-color: #9f7aea;
    }
    body.dark-mode .flatpickr-day.inrange {
      background-color: rgba(159, 122, 234, 0.3);
      border-color: rgba(159, 122, 234, 0.3);
    }
    body.dark-mode .flatpickr-day.flatpickr-disabled {
      color: #6b7280;
    }
    body.dark-mode .flatpickr-months .flatpickr-prev-month,
    body.dark-mode .flatpickr-months .flatpickr-next-month {
      fill: #e2e8f0;
    }
    body.dark-mode .flatpickr-current-month .flatpickr-month,
    body.dark-mode .flatpickr-current-month .flatpickr-year {
      color: #e2e8f0;
    }
    body.dark-mode .calendar-day.has-tasks {
      background-color: #6b46c140; /* Purple-600 with opacity */
    }
    body.dark-mode .calendar-day.today {
      border: 2px solid #9f7aea; /* Light purple border for today */
    }


    /* Custom Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    body.dark-mode .modal-content {
      background-color: #2d3748;
      color: #e2e8f0;
    }

    /* Basic loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #6366f1; /* Indigo-500 */
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Calendar Grid Specific Styles */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px; /* Small gap between days */
        background-color: #e2e8f0; /* Light background for grid lines */
        border: 1px solid #cbd5e0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    body.dark-mode .calendar-grid {
        background-color: #4a5568;
        border-color: #6b7280;
    }
    .calendar-day-header {
        background-color: #a78bfa; /* Purple-400 */
        color: white;
        padding: 0.5rem;
        text-align: center;
        font-weight: bold;
    }
    .calendar-day {
        background-color: white;
        color: #4a5568;
        padding: 0.75rem 0.5rem;
        min-height: 80px; /* Ensure days have some height */
        text-align: right;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-end;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    body.dark-mode .calendar-day {
        background-color: #2d3748;
        color: #e2e8f0;
    }
    .calendar-day:hover {
        background-color: #f3f4f6; /* Light gray on hover */
    }
    body.dark-mode .calendar-day:hover {
        background-color: #4a5568;
    }
    .calendar-day.other-month {
        background-color: #f7fafc;
        color: #a0aec0;
    }
    body.dark-mode .calendar-day.other-month {
        background-color: #1a202c;
        color: #718096;
    }
    .calendar-date-number {
        font-weight: bold;
        font-size: 1.25rem;
        color: #2d3748;
        z-index: 10;
        position: absolute;
        top: 5px;
        right: 5px;
    }
    body.dark-mode .calendar-date-number {
      color: #e2e8f0;
    }
    .calendar-tasks-indicator {
        font-size: 0.75rem;
        background-color: #6b46c1; /* Purple-600 */
        color: white;
        border-radius: 9999px; /* Full pill shape */
        padding: 0.1rem 0.4rem;
        position: absolute;
        bottom: 5px;
        left: 5px;
        font-weight: bold;
    }
  </style>
</head>
<body class="bg-gradient-to-r from-indigo-100 to-purple-200 min-h-screen text-gray-800 transition-colors duration-300 font-sans">

<!-- Confirmation Modal HTML -->
<div id="confirmationModal" class="modal-overlay hidden">
  <div class="modal-content dark:bg-gray-700 dark:text-gray-100">
    <p id="modalMessage" class="text-xl font-semibold mb-6"></p>
    <div class="flex justify-center space-x-4">
      <button id="modalConfirmBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200">Confirm</button>
      <button id="modalCancelBtn" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 transition-colors duration-200">Cancel</button>
    </div>
  </div>
</div>

<!-- Alert Modal HTML -->
<div id="alertModal" class="modal-overlay hidden">
  <div class="modal-content dark:bg-gray-700 dark:text-gray-100">
    <p id="alertMessage" class="text-xl font-semibold mb-6"></p>
    <button id="alertCloseBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">OK</button>
  </div>
</div>

<!-- Loading Spinner (Global) -->
<div id="loadingSpinner" class="modal-overlay hidden">
    <div class="spinner"></div>
</div>

<!-- Navbar -->
<nav class="bg-white dark:bg-gray-800 shadow px-4 py-3 flex justify-between items-center z-20 sticky top-0 transition-colors duration-300">
  <h1 class="text-2xl font-bold text-purple-700 dark:text-purple-400">üìÖ Schedule Planner Pro</h1>
  <div class="md:hidden">
    <button id="menuToggle" class="focus:outline-none text-gray-700 dark:text-gray-200 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>
  <ul id="mainMenu" class="hidden md:flex space-x-8 text-lg font-medium">
    <li><a href="#home" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">Home</a></li>
    <li><a href="#calendar-grid" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">Calendar</a></li>
    <li><a href="#todo" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">To-Do</a></li>
    <li><a href="#pomodoro" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">Pomodoro</a></li>
    <li><a href="#notes" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">Notes</a></li>
    <li><a href="#mood" class="text-gray-700 dark:text-gray-200 hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200">Mood</a></li>
    <li>
      <button onclick="toggleDarkMode()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-700 transition-colors duration-200 shadow-md">
        Toggle Dark Mode
      </button>
    </li>
    <li>
        <button onclick="signOutUser()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors duration-200 shadow-md">
            Sign Out
        </button>
    </li>
  </ul>
</nav>

<!-- Mobile Menu -->
<div id="mobileMenu" class="md:hidden hidden bg-white dark:bg-gray-800 p-6 space-y-4 text-center shadow-lg transition-all duration-300 ease-in-out z-10">
  <a href="#home" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2 border-b border-gray-200 dark:border-gray-700">Home</a>
  <a href="#calendar-grid" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2 border-b border-gray-200 dark:border-gray-700">Calendar</a>
  <a href="#todo" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2 border-b border-gray-200 dark:border-gray-700">To-Do</a>
  <a href="#pomodoro" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2 border-b border-gray-200 dark:border-gray-700">Pomodoro</a>
  <a href="#notes" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2 border-b border-gray-200 dark:border-gray-700">Notes</a>
  <a href="#mood" class="block text-gray-800 dark:text-gray-100 text-lg hover:text-purple-600 dark:hover:text-purple-400 transition-colors duration-200 py-2">Mood</a>
  <button onclick="toggleDarkMode()" class="w-full bg-gray-800 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 shadow-md mt-4">
    Toggle Dark Mode
  </button>
  <button onclick="signOutUser()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md mt-2">
    Sign Out
  </button>
</div>

<!-- Auth Section (Login/Signup) -->
<section id="authSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[1001] p-4 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md">
        <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center" id="authTitle">Login</h2>
        <input type="email" id="authEmail" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-2 focus:ring-purple-400" />
        <input type="password" id="authPassword" placeholder="Password" class="w-full p-3 mb-6 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:ring-2 focus:ring-purple-400" />
        <button id="loginBtn" onclick="handleAuth(true)" class="w-full bg-purple-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-purple-700 transition-colors duration-200 shadow-md mb-4">Login</button>
        <button id="signupBtn" onclick="handleAuth(false)" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 shadow-md">Sign Up</button>
        <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">
            <span id="authStatusText"></span>
            <button onclick="toggleAuthMode()" class="text-purple-600 dark:text-purple-400 hover:underline ml-1">Switch to <span id="authModeToggleText">Sign Up</span></button>
        </p>
    </div>
</section>

<!-- Main Content Sections -->
<div class="max-w-6xl mx-auto px-4 py-10 space-y-16">

  <!-- Home Section - Welcome Dashboard -->
  <section id="home" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-4xl font-extrabold text-center text-purple-700 dark:text-purple-400 mb-6">Welcome to Schedule Planner Pro!</h2>
    <p class="text-xl text-center text-gray-700 dark:text-gray-200 mb-8">Your personal hub for productivity and well-being.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-purple-100 dark:bg-purple-900 rounded-xl p-6 text-center shadow-md">
        <p class="text-5xl font-bold text-purple-800 dark:text-purple-200" id="tasksTodayCount">0</p>
        <p class="text-lg text-purple-700 dark:text-purple-300 mt-2">Tasks Due Today</p>
      </div>
      <div class="bg-blue-100 dark:bg-blue-900 rounded-xl p-6 text-center shadow-md">
        <p class="text-5xl font-bold text-blue-800 dark:text-blue-200" id="totalNotesCount">0</p>
        <p class="text-lg text-blue-700 dark:text-blue-300 mt-2">Total Notes</p>
      </div>
      <div class="bg-green-100 dark:bg-green-900 rounded-xl p-6 text-center shadow-md">
        <p class="text-5xl font-bold text-green-800 dark:text-green-200" id="pomodoroCompletedCount">0</p>
        <p class="text-lg text-green-700 dark:text-green-300 mt-2">Pomodoro Sessions Completed</p>
      </div>
    </div>

    <!-- Today's Focus Section -->
    <div class="mt-10 p-6 bg-gray-50 dark:bg-gray-800 rounded-xl shadow-inner">
        <h3 class="text-2xl font-bold text-purple-600 dark:text-purple-300 mb-4 text-center">üéØ Today's Focus</h3>
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <input type="text" id="todayFocusInput" placeholder="Set your main goal for today..." 
                   class="flex-1 w-full border border-gray-300 dark:border-gray-600 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 transition-colors duration-200 text-lg dark:text-gray-100" />
            <button onclick="setTodayFocus()" id="setFocusBtn" 
                    class="bg-indigo-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 shadow-md flex-shrink-0">Set Focus</button>
            <button onclick="clearTodayFocus()" id="clearFocusBtn" 
                    class="bg-gray-500 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-gray-600 transition-colors duration-200 shadow-md flex-shrink-0 hidden">Clear Focus</button>
        </div>
        <p id="currentFocusDisplay" class="text-center text-xl font-semibold text-gray-800 dark:text-gray-100 mt-6"></p>
    </div>

    <!-- Data Export/Import -->
    <div class="mt-10 p-6 bg-gray-50 dark:bg-gray-800 rounded-xl shadow-inner">
        <h3 class="text-2xl font-bold text-purple-600 dark:text-purple-300 mb-4 text-center">üíæ Data Management</h3>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button onclick="exportUserData()" class="bg-teal-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-teal-700 transition-colors duration-200 shadow-md">Export All Data</button>
            <label for="importFile" class="bg-orange-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-orange-700 transition-colors duration-200 shadow-md cursor-pointer">Import Data</label>
            <input type="file" id="importFile" accept=".json" class="hidden" onchange="importUserData(event)" />
        </div>
    </div>
  </section>

  <!-- Pomodoro Timer Section -->
  <section id="pomodoro" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center">‚è±Ô∏è Pomodoro Timer</h2>
    <div class="text-7xl font-mono text-center mb-6 text-gray-900 dark:text-gray-100" id="pomodoroDisplay">25:00</div>
    <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-6">
      <button onclick="startPomodoro()" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition-colors duration-200 transform hover:scale-105 shadow-lg">Start</button>
      <button onclick="pausePomodoro()" class="bg-yellow-500 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-yellow-600 transition-colors duration-200 transform hover:scale-105 shadow-lg">Pause</button>
      <button onclick="resetPomodoro()" class="bg-red-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-red-700 transition-colors duration-200 transform hover:scale-105 shadow-lg">Reset</button>
    </div>
     <!-- Pomodoro Settings -->
     <div class="mt-8 text-center">
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">Pomodoro Settings</h3>
        <label for="pomodoroDuration" class="mr-2 text-gray-700 dark:text-gray-300">Session (mins):</label>
        <input type="number" id="pomodoroDuration" value="25" min="1" class="w-20 p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500 text-gray-900 dark:text-gray-100">
        <button onclick="applyPomodoroSettings()" class="ml-3 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">Apply</button>
     </div>
     <!-- Pomodoro History -->
     <div class="mt-8">
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3 text-center">Recent Sessions</h3>
        <ul id="pomodoroHistoryList" class="space-y-2 text-center text-gray-700 dark:text-gray-300">
            <li>No sessions completed yet.</li>
        </ul>
     </div>
  </section>

  <!-- To-Do List Section -->
  <section id="todo" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center">üìã To-Do List</h2>
    <div class="mb-6 space-y-4">
      <input id="todoInput" type="text" placeholder="Add a new to-do..." 
             class="w-full border border-gray-300 dark:border-gray-600 p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 transition-colors duration-200 text-lg" />
      <input type="text" id="dueDateInput" placeholder="Due Date (optional)" 
             class="w-full border border-gray-300 dark:border-gray-600 p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 transition-colors duration-200 text-lg" />
      <select id="prioritySelect" 
              class="w-full border border-gray-300 dark:border-gray-600 p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 transition-colors duration-200 text-lg">
        <option value="low">Low Priority</option>
        <option value="medium">Medium Priority</option>
        <option value="high">High Priority</option>
      </select>
      <button onclick="addTodo()" class="w-full bg-purple-600 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:bg-purple-700 transition-colors duration-200 transform hover:scale-105 shadow-lg">Add To-Do</button>
    </div>

    <!-- Filter and Sort Options -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-3 sm:space-y-0 sm:space-x-4">
      <select id="filterStatus" class="w-full sm:w-auto p-3 border rounded-lg dark:bg-gray-600 dark:border-gray-500 text-gray-900 dark:text-gray-100" onchange="setupTodoRealtimeListener()">
        <option value="all">Show All</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>
      <select id="sortOrder" class="w-full sm:w-auto p-3 border rounded-lg dark:bg-gray-600 dark:border-gray-500 text-gray-900 dark:text-gray-100" onchange="setupTodoRealtimeListener()">
        <option value="timestampDesc">Newest First</option> <!-- Default: Newest first -->
        <option value="timestampAsc">Oldest First</option>
        <option value="dueDateAsc">Due Date (Soonest)</option>
        <option value="priorityHigh">Priority (High to Low)</option>
      </select>
    </div>

    <ul id="todoList" class="space-y-4"></ul>
  </section>

  <!-- Calendar Section (Grid View) -->
  <section id="calendar-grid" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center">üóìÔ∏è Monthly Calendar</h2>
    
    <div class="flex justify-between items-center mb-6">
        <button onclick="changeCalendarMonth(-1)" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">&lt; Prev</button>
        <h3 id="currentMonthYear" class="text-2xl font-bold text-gray-900 dark:text-gray-100"></h3>
        <button onclick="changeCalendarMonth(1)" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Next &gt;</button>
    </div>

    <div class="calendar-grid" id="calendarGridContainer">
        <!-- Day headers (Sun-Sat) -->
        <div class="calendar-day-header">Sun</div>
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>
        <!-- Calendar days will be dynamically inserted here -->
    </div>

    <div id="calendarDayDetails" class="mt-8 bg-gray-50 dark:bg-gray-800 p-6 rounded-lg shadow-inner hidden">
        <h3 id="calendarDetailDate" class="text-xl font-bold text-purple-600 dark:text-purple-300 mb-4"></h3>
        <ul id="calendarDetailTasksList" class="space-y-2"></ul>
    </div>
  </section>

  <!-- Notes Section -->
  <section id="notes" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center">üìù My Notes</h2>
    <div class="mb-6 space-y-4">
      <textarea id="noteInput" rows="4" placeholder="Jot down your thoughts..." 
                class="w-full border border-gray-300 dark:border-gray-600 p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 transition-colors duration-200 text-lg"></textarea>
      <button onclick="addNote()" class="w-full bg-blue-600 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105 shadow-lg">Add Note</button>
    </div>
    <div id="notesList" class="space-y-4"></div>
  </section>

  <!-- Mood Tracker Section -->
  <section id="mood" class="bg-white dark:bg-gray-700 rounded-2xl shadow-xl p-8 transform hover:scale-[1.005] transition-transform duration-300">
    <h2 class="text-3xl font-extrabold text-purple-700 dark:text-purple-400 mb-6 text-center">üòä Mood Tracker</h2>
    <p class="text-lg text-center text-gray-700 dark:text-gray-200 mb-6">Track your daily mood to understand your well-being patterns.</p>
    <div class="flex justify-center space-x-4 mb-6">
      <button class="text-5xl hover:scale-110 transition-transform duration-200" onclick="logMood('happy')">üòÑ</button>
      <button class="text-5xl hover:scale-110 transition-transform duration-200" onclick="logMood('neutral')">üòê</button>
      <button class="text-5xl hover:scale-110 transition-transform duration-200" onclick="logMood('sad')">üòû</button>
      <button class="text-5xl hover:scale-110 transition-transform duration-200" onclick="logMood('stressed')">üòü</button>
    </div>
    <p class="text-center text-gray-600 dark:text-gray-300" id="moodLogMessage">Select an emoji to log your mood!</p>
    <!-- Mood History -->
    <div class="mt-8">
      <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3 text-center">Recent Moods</h3>
      <ul id="moodHistoryList" class="space-y-2">
        <!-- Mood items will be rendered here -->
      </ul>
    </div>
  </section>

</div>

<!-- Footer -->
<footer class="bg-gray-800 text-white dark:bg-gray-900 py-6 text-center mt-12">
  <p class="text-sm">&copy; 2025 Schedule Planner Pro. All rights reserved.</p>
  <p class="text-xs mt-2 opacity-80">Designed with ‚ù§Ô∏è for a productive life.</p>
</footer>


<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  // Firebase configuration using provided global variables
  // IMPORTANT: This configuration is now pulled from the environment if available,
  // otherwise it uses the placeholder values.
  const firebaseConfig = {
    apiKey: "AIzaSyD3lcWTojgHRXDL4nEWoIbhsGqvxJ-dRXk",
    authDomain: "hassan131-6c659.firebaseapp.com",
    projectId: "hassan131-6c659",
    storageBucket: "hassan131-6c659.firebasestorage.app",
    messagingSenderId: "217383242954",
    appId: "1:217383242954:web:b2498ac00ce22db3f37833",
    measurementId: "G-77367DH2NP"
  };

  // Override with __firebase_config if running in a Canvas environment
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
      try {
          const canvasConfig = JSON.parse(__firebase_config);
          Object.assign(firebaseConfig, canvasConfig);
          console.log("Using Firebase config from Canvas environment.");
      } catch (e) {
          console.error("Error parsing __firebase_config from Canvas, using default. ", e);
      }
  }

  // Initialize Firebase App
  const app = firebase.initializeApp(firebaseConfig);
  const db = app.firestore();
  const auth = app.auth(); // Get Auth instance

  let currentUserId = null; // To store the authenticated user ID
  let calendarDaysWithTasks = {}; // Cache for tasks by date string (YYYY-MM-DD), used by calendar grid

  // --- Authentication Logic ---
  const authSection = document.getElementById('authSection');
  const authTitle = document.getElementById('authTitle');
  const authEmailInput = document.getElementById('authEmail');
  const authPasswordInput = document.getElementById('authPassword');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const authStatusText = document.getElementById('authStatusText');
  const authModeToggleText = document.getElementById('authModeToggleText');
  let isLoginMode = true; // True for login, false for signup

  function showAuthModal() {
    authSection.classList.remove('hidden');
    updateAuthUI();
  }

  function hideAuthModal() {
    authSection.classList.add('hidden');
  }

  function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    updateAuthUI();
  }

  function updateAuthUI() {
    authTitle.innerText = isLoginMode ? 'Login' : 'Sign Up';
    loginBtn.innerText = isLoginMode ? 'Login' : 'Login Existing'; // Text for when user is on signup mode but wants to login
    signupBtn.innerText = isLoginMode ? 'Create Account' : 'Sign Up'; // Text for when user is on login mode but wants to create account
    authModeToggleText.innerText = isLoginMode ? 'Sign Up' : 'Login';
    authStatusText.innerText = isLoginMode ? 'Don\'t have an account?' : 'Already have an account?';
  }

  async function handleAuth(isLoginAttempt) {
    showLoadingSpinner();
    const email = authEmailInput.value;
    const password = authPasswordInput.value;

    if (!email || !password) {
      hideLoadingSpinner();
      showAlertModal("Please enter both email and password.");
      return;
    }

    try {
      if (isLoginAttempt) {
        await auth.signInWithEmailAndPassword(email, password);
      } else {
        await auth.createUserWithEmailAndPassword(email, password);
      }
      // The onAuthStateChanged listener will handle hiding modal and spinner on success
    } catch (error) {
      console.error("Auth error:", error);
      showAlertModal(`Authentication failed: ${error.message}`);
    } finally {
      // Ensure spinner is hidden in all cases after auth attempt
      hideLoadingSpinner();
    }
  }

  // Firebase Auth State Listener
  auth.onAuthStateChanged(async (user) => {
    try {
        if (user) {
            currentUserId = user.uid;
            console.log("Authenticated as:", user.email || 'Guest', "UID:", currentUserId);

            hideAuthModal(); // Hide Auth modal if successfully authenticated

            // Load user-specific data after authentication
            // These calls should be robust to permissions errors themselves,
            // but the rules are now configured to allow access.
            setupTodoRealtimeListener();
            setupNotesRealtimeListener();
            loadMoodHistory();
            loadTodayFocus();
            loadPomodoroHistory();

            requestNotificationPermission();
            
        } else {
            currentUserId = null;
            console.log("No user authenticated. Attempting anonymous sign-in or showing login/signup.");

            // Clear UI if no user is authenticated (e.g., after sign out)
            todoList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your tasks.</li>';
            notesList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your notes.</li>';
            moodHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your mood history.</li>';
            pomodoroHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">No sessions completed yet.</li>';
            currentFocusDisplay.innerText = "Please log in to set your focus.";
            tasksTodayCount.innerText = '0';
            totalNotesCount.innerText = '0';
            document.getElementById('pomodoroCompletedCount').innerText = '0';
            
            try {
                // Try to sign in with custom token first if available (for Canvas environment)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    // Fallback to anonymous sign-in if no custom token or if custom token sign-in fails
                    await auth.signInAnonymously();
                }
                // If sign-in is successful, onAuthStateChanged will be re-triggered with a user object.
            } catch (error) {
                console.error("Error during initial authentication (custom token/anonymous):", error);
                showAlertModal("Failed to authenticate automatically. Please log in or sign up.");
                showAuthModal(); // Show login modal if anonymous/custom token fails
            }
        }
    } catch (error) {
        console.error("Critical error in onAuthStateChanged:", error);
        showAlertModal("An unexpected error occurred during authentication. Please refresh the page.");
    } finally {
        // This is crucial: Ensure spinner is hidden AFTER all auth processing is done.
        hideLoadingSpinner();
    }
  });

  async function signOutUser() {
    showConfirmationModal("Are you sure you want to sign out?", async (confirmed) => {
        if (confirmed) {
            showLoadingSpinner();
            try {
                await auth.signOut();
                showAlertModal("You have been signed out.");
                // UI is cleared by the `else` block in `onAuthStateChanged`
            } catch (error) {
                console.error("Error signing out:", error);
                showAlertModal(`Sign out failed: ${error.message}`);
            } finally {
                hideLoadingSpinner();
            }
        }
    });
  }

  // --- Utility Functions for Custom Modals (Replacing alert/confirm) ---
  /**
   * Displays a custom confirmation modal.
   * @param {string} message - The message to display in the modal.
   * @param {function(boolean): void} onConfirm - Callback function invoked with `true` if confirmed, `false` if cancelled.
   */
  function showConfirmationModal(message, onConfirm) {
    const modal = document.getElementById('confirmationModal');
    document.getElementById('modalMessage').innerText = message;
    modal.classList.remove('hidden'); // Show the modal

    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    // Clear previous event listeners to prevent multiple calls
    confirmBtn.onclick = null;
    cancelBtn.onclick = null;

    confirmBtn.onclick = () => {
      modal.classList.add('hidden'); // Hide the modal
      onConfirm(true); // Call callback with true for confirmation
    };
    cancelBtn.onclick = () => {
      modal.classList.add('hidden'); // Hide the modal
      onConfirm(false); // Call callback with false for cancellation
    };
  }

  /**
   * Displays a custom alert modal.
   * @param {string} message - The message to display in the modal.
   */
  function showAlertModal(message) {
    hideLoadingSpinner(); // Always hide the loading spinner before showing an alert
    const modal = document.getElementById('alertModal');
    document.getElementById('alertMessage').innerText = message;
    modal.classList.remove('hidden'); // Show the modal

    const closeBtn = document.getElementById('alertCloseBtn');
    closeBtn.onclick = null; // Clear previous event listeners
    closeBtn.onclick = () => {
      modal.classList.add('hidden'); // Hide the modal
    };
  }

  /** Shows the global loading spinner. */
  function showLoadingSpinner() {
    document.getElementById('loadingSpinner').classList.remove('hidden');
  }

  /** Hides the global loading spinner. */
  function hideLoadingSpinner() {
    document.getElementById('loadingSpinner').classList.add('hidden');
  }


  // --- Navbar and General UI Functions ---

  // Hamburger menu toggle for mobile view
  document.getElementById("menuToggle").onclick = () => {
    document.getElementById("mobileMenu").classList.toggle("hidden");
  }

  // Close mobile menu when a navigation link is clicked
  document.querySelectorAll("#mobileMenu a").forEach(link => {
    link.addEventListener("click", () => {
      document.getElementById("mobileMenu").classList.add("hidden");
    });
  });

  // Smooth scrolling for all navigation links (desktop and mobile)
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault(); // Prevent default hash behavior
      document.querySelector(this.getAttribute('href')).scrollIntoView({
        behavior: 'smooth' // Smooth scroll to the target section
      });
    });
  });

  // Dark Mode Toggle functionality
  function toggleDarkMode() {
    document.body.classList.toggle("dark-mode"); // Toggle the dark-mode class on the body
    // Store user preference in local storage for persistence
    if (document.body.classList.contains("dark-mode")) {
      localStorage.setItem("theme", "dark");
    } else {
      localStorage.setItem("theme", "light");
    }
  }

  // Apply saved theme preference when the DOM is fully loaded
  document.addEventListener("DOMContentLoaded", () => {
    // Show spinner immediately when the page starts loading
    showLoadingSpinner();

    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
    }
    // The rest of the initial setup (Firebase auth and data loading) will be handled
    // by the `auth.onAuthStateChanged` listener, which will hide the spinner
    // once the auth state is resolved and data listeners are set up.
  });


  // --- Pomodoro Timer Logic ---

  let pomodoroTime = 25 * 60; // Default: 25 minutes (in seconds)
  let pomodoroInterval; // Variable to hold the setInterval ID
  let isPomodoroRunning = false; // Flag to prevent multiple timers
  const pomodoroDisplay = document.getElementById("pomodoroDisplay"); // Timer display element
  const pomodoroDurationInput = document.getElementById("pomodoroDuration"); // Input for custom duration
  const pomodoroCompletedCountDisplay = document.getElementById("pomodoroCompletedCount");
  const pomodoroHistoryList = document.getElementById("pomodoroHistoryList");

  /** Updates the Pomodoro timer display. */
  function updatePomodoroDisplay() {
    const minutes = Math.floor(pomodoroTime / 60).toString().padStart(2, '0'); // Calculate minutes and pad with leading zero
    const seconds = (pomodoroTime % 60).toString().padStart(2, '0'); // Calculate seconds and pad with leading zero
    pomodoroDisplay.innerText = `${minutes}:${seconds}`; // Update the text content
  }

  /** Starts the Pomodoro timer countdown. */
  function startPomodoro() {
    if (!currentUserId) {
        showAlertModal("Please log in to use the Pomodoro Timer.");
        return;
    }
    if (isPomodoroRunning) return; // Exit if timer is already running
    isPomodoroRunning = true; // Set flag to true
    pomodoroInterval = setInterval(() => {
      if (pomodoroTime > 0) {
        pomodoroTime--; // Decrement time
        updatePomodoroDisplay(); // Update display
      } else {
        clearInterval(pomodoroInterval); // Stop the interval when timer reaches 0
        pomodoroInterval = null;
        isPomodoroRunning = false;
        showAlertModal("üéâ Pomodoro session complete! Time for a break."); // Alert user
        logPomodoroCompletion(); // Log completion to Firebase
        resetPomodoro(); // Reset timer for the next session
        triggerNotification("Pomodoro Complete!", "Your Pomodoro session has ended. Time for a break!");
      }
    }, 1000); // Update every second (1000ms)
  }

  /** Pauses the Pomodoro timer. */
  function pausePomodoro() {
    clearInterval(pomodoroInterval); // Stop the interval
    pomodoroInterval = null;
    isPomodoroRunning = false;
  }

  /** Resets the Pomodoro timer to its initial duration. */
  function resetPomodoro() {
    // Reset time to the value from the input, converted to seconds
    pomodoroTime = parseInt(pomodoroDurationInput.value) * 60;
    updatePomodoroDisplay(); // Update display immediately
    clearInterval(pomodoroInterval); // Stop any running interval
    pomodoroInterval = null;
    isPomodoroRunning = false;
  }

  /** Applies the custom Pomodoro duration set by the user. */
  function applyPomodoroSettings() {
    const newDuration = parseInt(pomodoroDurationInput.value); // Get new duration from input
    // Validate input
    if (isNaN(newDuration) || newDuration <= 0) {
      showAlertModal("Please enter a valid positive number for Pomodoro duration.");
      pomodoroDurationInput.value = '25'; // Reset input to default if invalid
      return;
    }
    pomodoroTime = newDuration * 60; // Update timer duration
    updatePomodoroDisplay(); // Update display
    pausePomodoro(); // Pause any active timer when settings are applied
    showAlertModal(`Pomodoro session set to ${newDuration} minutes.`);
  }

  /** Logs a completed Pomodoro session to Firestore. */
  async function logPomodoroCompletion() {
    if (!currentUserId) return;
    try {
        await db.collection("users").doc(currentUserId).collection("pomodoroSessions").add({
            duration: parseInt(pomodoroDurationInput.value),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadPomodoroHistory();
    } catch (error) {
        console.error("Error logging pomodoro session:", error);
    }
  }

  /** Loads and displays recent Pomodoro session history. */
  async function loadPomodoroHistory() {
    if (!currentUserId) {
        pomodoroHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your session history.</li>';
        pomodoroCompletedCountDisplay.innerText = '0';
        return;
    }
    pomodoroHistoryList.innerHTML = '';
    let completedCount = 0;
    try {
        // Removed .orderBy("timestamp", "desc") from Firestore query
        const snapshot = await db.collection("users").doc(currentUserId).collection("pomodoroSessions").limit(5).get();
        let sessions = [];
        snapshot.forEach(doc => {
            const sessionData = doc.data();
            const timestamp = (sessionData.timestamp instanceof firebase.firestore.Timestamp) ? sessionData.timestamp.toDate() : (sessionData.timestamp ? new Date(sessionData.timestamp) : new Date(0));
            sessions.push({ ...sessionData, id: doc.id, timestamp: timestamp });
        });

        // Client-side sort by timestamp (newest first)
        sessions.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

        if (sessions.length === 0) {
            pomodoroHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">No sessions completed yet.</li>';
        } else {
            sessions.forEach(session => {
                const li = document.createElement("li");
                li.className = "p-2 bg-gray-50 dark:bg-gray-600 rounded-md shadow-sm text-gray-700 dark:text-gray-200 flex justify-between items-center";
                li.innerHTML = `<span>${session.duration} mins session</span> <span class="text-sm text-gray-500 dark:text-gray-400">${session.timestamp.toLocaleString()}</span>`;
                pomodoroHistoryList.appendChild(li);
            });
        }
        // Count total sessions (still needs to fetch all for count)
        const allSessionsSnapshot = await db.collection("users").doc(currentUserId).collection("pomodoroSessions").get();
        completedCount = allSessionsSnapshot.size;
        pomodoroCompletedCountDisplay.innerText = completedCount;
    } catch (error) {
        console.error("Error loading pomodoro history:", error);
        pomodoroHistoryList.innerHTML = '<li class="text-red-500 dark:text-red-300 text-center py-2">Error loading history.</li>';
        pomodoroCompletedCountDisplay.innerText = '0';
    } finally {
      hideLoadingSpinner(); // Ensure spinner is hidden
    }
  }

  updatePomodoroDisplay(); // Initial display update when page loads


  // --- To-Do List Logic ---

  const todoInput = document.getElementById("todoInput"); // Input for new task text
  const dueDateInput = document.getElementById("dueDateInput"); // Input for due date
  const prioritySelect = document.getElementById("prioritySelect"); // Select for priority
  const todoList = document.getElementById("todoList"); // UL element to display todos
  const filterStatus = document.getElementById("filterStatus"); // Filter dropdown
  const sortOrder = document.getElementById("sortOrder"); // Sort dropdown
  const tasksTodayCount = document.getElementById("tasksTodayCount"); // Dashboard count for tasks due today

  // Initialize Flatpickr for the due date input field
  flatpickr(dueDateInput, {
    enableTime: false, // Only date selection, no time
    dateFormat: "Y-m-d", // Date format for Firebase storage
    minDate: "today", // Only allow future or today's dates
    altInput: true, // Show user-friendly format in input
    altFormat: "F j, Y", // User-friendly date format (e.g., "June 15, 2025")
    appendTo: document.body // Prevents styling issues with modals/popups
  });

  /**
   * Renders a single to-do item into the DOM.
   * @param {Object} doc - Firestore document snapshot (containing id and data).
   */
  function renderTodoItem(doc) {
    const todo = doc.data(); // Get data from the document
    const li = document.createElement("li"); // Create a new list item
    li.id = `todo-${doc.id}`; // Assign a unique ID for easy manipulation
    // Apply Tailwind classes for styling, priority color, and completion status
    li.className = `flex flex-col sm:flex-row justify-between items-start sm:items-center bg-purple-50 dark:bg-gray-600 px-4 py-3 rounded-lg shadow-md mb-2 transition-all duration-200 
                    task-priority-${todo.priority} ${todo.completed ? 'opacity-60 line-through' : ''}`;

    let dueDateText = '';
    // Format and display due date if it exists
    if (todo.dueDate) {
      const date = new Date(todo.dueDate);
      dueDateText = `<span class="text-sm text-gray-600 dark:text-gray-300 ml-0 sm:ml-4 mt-1 sm:mt-0 italic">Due: ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>`;
    }

    // Set the inner HTML of the list item with task details and controls
    li.innerHTML = `
      <div class="flex-1 flex items-center flex-wrap">
        <input type="checkbox" class="mr-3 h-5 w-5 text-purple-600 rounded focus:ring-purple-500 cursor-pointer" 
               ${todo.completed ? 'checked' : ''} onchange="toggleTodoComplete('${doc.id}', event.target.checked)">
        <span id="todoText-${doc.id}" class="text-lg text-gray-800 dark:text-gray-100 font-medium break-words flex-1">${todo.text}</span>
        ${dueDateText}
      </div>
      <div class="flex items-center space-x-3 mt-2 sm:mt-0">
        <span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${getPriorityColor(todo.priority)}">${todo.priority}</span>
        <button class='text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-600 text-xl transition-colors duration-200' onclick='editTodo("${doc.id}")' title="Edit To-Do">‚úèÔ∏è</button>
        <button class='text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600 text-xl transition-colors duration-200 ml-2" onclick='deleteTodo("${doc.id}")' title="Delete To-Do">‚úñ</button>
      </div>
    `;
    todoList.appendChild(li); // Add the new list item to the to-do list UL
  }

  /**
   * Helper function to return Tailwind CSS classes for priority-based colors.
   * @param {string} priority - The priority level ('high', 'medium', 'low').
   * @returns {string} - Tailwind CSS classes.
   */
  function getPriorityColor(priority) {
    switch (priority) {
      case 'high':
        return 'bg-red-200 text-red-800 dark:bg-red-700 dark:text-red-100';
      case 'medium':
        return 'bg-yellow-200 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100';
      case 'low':
        return 'bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-100';
      default:
        return 'bg-gray-200 text-gray-800 dark:bg-gray-500 dark:text-gray-100';
    }
  }

  /** Adds a new to-do item to Firestore. */
  async function addTodo() {
    if (!currentUserId) {
        showAlertModal("Please log in to add tasks.");
        return;
    }
    showLoadingSpinner(); // Show loading spinner
    const task = todoInput.value.trim(); // Get task text and trim whitespace
    const dueDate = dueDateInput.value; // Get due date
    const priority = prioritySelect.value; // Get priority

    if (task === "") {
      hideLoadingSpinner();
      showAlertModal("Please enter a task!"); // Validate input
      return;
    }

    try {
      // Add document to 'todos' subcollection under current user's document
      await db.collection("users").doc(currentUserId).collection("todos").add({
        text: task,
        dueDate: dueDate,
        priority: priority,
        completed: false, // New tasks are not completed by default
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Server timestamp for reliable ordering
      });
      // Clear input fields after successful addition
      todoInput.value = "";
      dueDateInput.value = "";
      prioritySelect.value = "low"; // Reset priority to default
      // onSnapshot listener will handle UI update
      showAlertModal("Task added successfully!"); // Provide feedback
    } catch (error) {
      console.error("Error adding document: ", error);
      showAlertModal("Failed to add to-do. Please try again.");
    } finally {
      hideLoadingSpinner(); // Hide loading spinner
    }
  }

  // Allow adding a to-do by pressing Enter in the task input field
  todoInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      addTodo();
    }
  });


  /**
   * Enables editing for a specific to-do item, replacing its display with input fields.
   * @param {string} id - The ID of the to-do document in Firestore.
   */
  async function editTodo(id) {
    if (!currentUserId) return;
    const todoRef = db.collection("users").doc(currentUserId).collection("todos").doc(id); // Reference to the document
    try {
      const doc = await todoRef.get(); // Fetch the document
      if (!doc.exists) {
        showAlertModal("Task not found!");
        return;
      }
      const todo = doc.data(); // Get document data

      // Get the existing list item element
      const listItem = document.getElementById(`todo-${id}`);
      // Replace its inner HTML with an editable form
      listItem.innerHTML = `
        <div class="flex-1 flex flex-col sm:flex-row items-start sm:items-center flex-wrap gap-2 w-full">
          <input type="text" id="editTodoText-${id}" value="${todo.text}"
                 class="flex-1 border border-gray-300 dark:border-gray-600 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 text-lg dark:text-gray-100 w-full sm:w-auto" />
          <input type="text" id="editDueDate-${id}" value="${todo.dueDate || ''}" placeholder="Due Date (optional)"
                 class="border border-gray-300 dark:border-gray-600 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 text-lg dark:text-gray-100 w-full sm:w-auto" />
          <select id="editPriority-${id}"
                  class="w-full sm:w-auto border border-gray-300 dark:border-gray-600 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 text-lg dark:text-gray-100">
            <option value="low" ${todo.priority === 'low' ? 'selected' : ''}>Low Priority</option>
            <option value="medium" ${todo.priority === 'medium' ? 'selected' : ''}>Medium Priority</option>
            <option value="high" ${todo.priority === 'high' ? 'selected' : ''}>High Priority</option>
          </select>
        </div>
        <div class="flex items-center space-x-3 mt-2 sm:mt-0">
          <button class='bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200' onclick='saveTodo("${id}")'>Save</button>
          <button class='bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200' onclick='setupTodoRealtimeListener()'>Cancel</button>
        </div>
      `;
      // Re-initialize Flatpickr for the newly created due date input field
      flatpickr(document.getElementById(`editDueDate-${id}`), {
        enableTime: false,
        dateFormat: "Y-m-d",
        minDate: "today",
        altInput: true,
        altFormat: "F j, Y",
        appendTo: document.body
      });

    } catch (error) {
      console.error("Error fetching document for edit: ", error);
      showAlertModal("Failed to load task for editing. Please try again.");
    }
  }

  /**
   * Saves the edited details of a to-do item to Firestore.
   * @param {string} id - The ID of the to-do document to update.
   */
  async function saveTodo(id) {
    if (!currentUserId) return;
    showLoadingSpinner();
    // Get the new values from the edit input fields
    const newText = document.getElementById(`editTodoText-${id}`).value.trim();
    const newDueDate = document.getElementById(`editDueDate-${id}`).value;
    const newPriority = document.getElementById(`editPriority-${id}`).value;

    if (newText === "") {
      hideLoadingSpinner();
      showAlertModal("Task text cannot be empty!");
      return;
    }

    try {
      // Update the document in Firestore
      await db.collection("users").doc(currentUserId).collection("todos").doc(id).update({
        text: newText,
        dueDate: newDueDate,
        priority: newPriority
      });
      // onSnapshot listener will handle UI update
      showAlertModal("Task updated successfully!");
    } catch (error) {
      console.error("Error updating document: ", error);
      showAlertModal("Failed to update to-do. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }


  /**
   * Deletes a to-do item from Firestore.
   * @param {string} id - The ID of the to-do document to delete.
   */
  async function deleteTodo(id) {
    if (!currentUserId) return;
    // Show confirmation modal before deleting
    showConfirmationModal("Are you sure you want to delete this to-do?", async (confirmed) => {
      if (confirmed) {
        showLoadingSpinner();
        try {
          await db.collection("users").doc(currentUserId).collection("todos").doc(id).delete(); // Delete document from Firestore
          // onSnapshot listener will handle UI update
          showAlertModal("Task deleted successfully!");
        } catch (error) {
          console.error("Error removing document: ", error);
          showAlertModal("Failed to delete to-do. Please try again.");
        } finally {
          hideLoadingSpinner();
        }
      }
    });
  }

  /**
   * Toggles the completion status of a to-do item in Firestore.
   * @param {string} id - The ID of the to-do document to update.
   * @param {boolean} completed - The new completion status.
   */
  async function toggleTodoComplete(id, completed) {
    if (!currentUserId) return;
    showLoadingSpinner();
    try {
      await db.collection("users").doc(currentUserId).collection("todos").doc(id).update({
        completed: completed // Update the 'completed' field
      });
      // onSnapshot listener will handle UI update
    } catch (error) {
      console.error("Error updating document: ", error);
      showAlertModal("Failed to update to-do status. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }

  /**
   * Sets up a real-time listener for to-do items from Firestore.
   * This function will automatically update the UI whenever data changes in the 'todos' collection.
   */
  function setupTodoRealtimeListener() {
    if (!currentUserId) {
        todoList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your tasks.</li>';
        tasksTodayCount.innerText = '0';
        calendarDaysWithTasks = {}; // Clear calendar task data
        renderCalendar(currentCalendarMonth, currentCalendarYear); // Re-render calendar
        return;
    }
    db.collection("users").doc(currentUserId).collection("todos")
      // Removed .orderBy("timestamp", "desc") from Firestore query
      .onSnapshot(async (snapshot) => {
        showLoadingSpinner(); // Always show for a brief moment for visual feedback

        todoList.innerHTML = ''; // Clear existing list
        let todos = [];
        let tasksForCalendar = {}; // To collect tasks for calendar grid
        const todayDateString = new Date().toISOString().split('T')[0];
        let todayTasks = 0;

        snapshot.forEach(doc => {
          // Robustly handle timestamp conversion
          const timestampData = doc.data().timestamp;
          const convertedTimestamp = (timestampData instanceof firebase.firestore.Timestamp) 
                                      ? timestampData.toDate() 
                                      : (timestampData ? new Date(timestampData) : new Date(0));
          
          const todoData = { id: doc.id, ...doc.data(), timestamp: convertedTimestamp };
          todos.push(todoData);

          // Collect tasks for calendar
          if (todoData.dueDate) {
              if (!tasksForCalendar[todoData.dueDate]) {
                  tasksForCalendar[todoData.dueDate] = [];
              }
              tasksForCalendar[todoData.dueDate].push(todoData);
          }
          // Count tasks due today
          if (todoData.dueDate === todayDateString && !todoData.completed) {
              todayTasks++;
          }
        });

        tasksTodayCount.innerText = todayTasks; // Update dashboard count
        calendarDaysWithTasks = tasksForCalendar; // Update global calendar task cache
        renderCalendar(currentCalendarMonth, currentCalendarYear); // Re-render calendar with new task data

        // Apply filters (client-side)
        const selectedFilter = filterStatus.value;
        if (selectedFilter === "pending") {
          todos = todos.filter(todo => !todo.completed);
        } else if (selectedFilter === "completed") {
          todos = todos.filter(todo => todo.completed);
        }

        // Apply sorting (client-side)
        const selectedSort = sortOrder.value;
        if (selectedSort === "timestampAsc") {
          todos.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
        } else if (selectedSort === "timestampDesc") {
          todos.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
        } else if (selectedSort === "dueDateAsc") {
          todos.sort((a, b) => {
              // Sort by due date, pushing null/empty due dates to the end
              const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
              const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
              return dateA - dateB;
          });
        } else if (selectedSort === "priorityHigh") {
          const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
          todos.sort((a, b) => {
            const prioA = priorityOrder[a.priority] || 4;
            const prioB = priorityOrder[b.priority] || 4;
            if (prioA === prioB) {
              return b.timestamp.getTime() - a.timestamp.getTime(); // Secondary sort by newest
            }
            return prioA - prioB;
          });
        }

        // Render filtered and sorted todos
        todos.forEach(todo => {
          renderTodoItem({ id: todo.id, data: () => todo });
        });
        hideLoadingSpinner();
      }, (error) => {
        console.error("Error loading todos in real-time: ", error);
        showAlertModal("Failed to load to-dos in real-time. Please check your internet connection.");
        hideLoadingSpinner();
      });
  }

  // Initial load or re-load based on filters/sort
  filterStatus.addEventListener("change", setupTodoRealtimeListener);
  sortOrder.addEventListener("change", setupTodoRealtimeListener);


  // --- Calendar Grid View Logic ---
  const calendarGridContainer = document.getElementById("calendarGridContainer");
  const currentMonthYearDisplay = document.getElementById("currentMonthYear");
  const calendarDayDetails = document.getElementById("calendarDayDetails");
  const calendarDetailDate = document.getElementById("calendarDetailDate");
  const calendarDetailTasksList = document.getElementById("calendarDetailTasksList");

  let currentCalendarDate = new Date(); // Current date for calendar month view
  let currentCalendarMonth = currentCalendarDate.getMonth();
  let currentCalendarYear = currentCalendarDate.getFullYear();
  // calendarDaysWithTasks is updated by setupTodoRealtimeListener

  /** Renders the calendar grid for the given month and year. */
  function renderCalendar(month, year) {
      calendarGridContainer.innerHTML = `
          <div class="calendar-day-header">Sun</div>
          <div class="calendar-day-header">Mon</div>
          <div class="calendar-day-header">Tue</div>
          <div class="calendar-day-header">Wed</div>
          <div class="calendar-day-header">Thu</div>
          <div class="calendar-day-header">Fri</div>
          <div class="calendar-day-header">Sat</div>
      `; // Reset grid and add headers

      currentMonthYearDisplay.innerText = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const startDay = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday etc.

      // Calculate days from previous month to display
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay; i > 0; i--) {
          const day = prevMonthLastDay - i + 1;
          const date = new Date(year, month - 1, day);
          const dateString = date.toISOString().split('T')[0];
          const tasksOnDay = calendarDaysWithTasks[dateString] ? calendarDaysWithTasks[dateString].length : 0;
          appendCalendarDay(day, 'other-month', dateString, tasksOnDay);
      }

      // Render days of the current month
      for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
          const date = new Date(year, month, day);
          const dateString = date.toISOString().split('T')[0];
          const isToday = date.toDateString() === new Date().toDateString();
          const tasksOnDay = calendarDaysWithTasks[dateString] ? calendarDaysWithTasks[dateString].length : 0;
          appendCalendarDay(day, isToday ? 'today' : '', dateString, tasksOnDay);
      }

      // Render days from next month to fill the grid
      const totalDaysDisplayed = startDay + lastDayOfMonth.getDate();
      const remainingSlots = 42 - totalDaysDisplayed; // Max 6 rows * 7 days = 42 slots
      for (let i = 1; i <= remainingSlots; i++) {
          const date = new Date(year, month + 1, i);
          const dateString = date.toISOString().split('T')[0];
          const tasksOnDay = calendarDaysWithTasks[dateString] ? calendarDaysWithTasks[dateString].length : 0;
          appendCalendarDay(i, 'other-month', dateString, tasksOnDay);
      }
  }

  /** Appends a single day to the calendar grid. */
  function appendCalendarDay(dayNumber, classes, dateString, tasksCount) {
      const dayElement = document.createElement('div');
      dayElement.className = `calendar-day ${classes}`;
      dayElement.setAttribute('data-date', dateString);
      dayElement.innerHTML = `
          <span class="calendar-date-number">${dayNumber}</span>
          ${tasksCount > 0 ? `<span class="calendar-tasks-indicator">${tasksCount} task${tasksCount > 1 ? 's' : ''}</span>` : ''}
      `;
      dayElement.onclick = () => showDayDetails(dateString);
      calendarGridContainer.appendChild(dayElement);
  }

  /** Changes the displayed calendar month. */
  function changeCalendarMonth(offset) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
      currentCalendarMonth = currentCalendarDate.getMonth();
      currentCalendarYear = currentCalendarDate.getFullYear();
      renderCalendar(currentCalendarMonth, currentCalendarYear);
  }

  /** Shows details of tasks for a selected day in the calendar. */
  function showDayDetails(dateString) {
      calendarDetailDate.innerText = `Tasks for ${new Date(dateString).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
      calendarDetailTasksList.innerHTML = ''; // Clear previous details

      const tasks = calendarDaysWithTasks[dateString];
      if (tasks && tasks.length > 0) {
          // Sort tasks for display (e.g., by priority)
          tasks.sort((a, b) => {
              const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
              return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
          });

          tasks.forEach(task => {
              const li = document.createElement('li');
              li.className = `p-2 bg-white dark:bg-gray-600 rounded-md shadow-sm text-gray-800 dark:text-gray-100 ${task.completed ? 'opacity-60 line-through' : ''}`;
              li.innerHTML = `
                  <span class="font-semibold">${task.text}</span>
                  <span class="text-sm ml-2 text-gray-600 dark:text-gray-300">(${task.priority} priority)</span>
              `;
              calendarDetailTasksList.appendChild(li);
          });
      } else {
          calendarDetailTasksList.innerHTML = '<li class="text-gray-600 dark:text-gray-300">No tasks for this day.</li>';
      }
      calendarDayDetails.classList.remove('hidden'); // Show details panel
  }

  // --- Notes Section Logic ---

  const noteInput = document.getElementById("noteInput"); // Input for new note text
  const notesList = document.getElementById("notesList"); // Div to display notes
  const totalNotesCount = document.getElementById("totalNotesCount"); // Dashboard count for notes

  /** Adds a new note to Firestore. */
  async function addNote() {
    if (!currentUserId) {
        showAlertModal("Please log in to add notes.");
        return;
    }
    showLoadingSpinner();
    const noteText = noteInput.value.trim();
    if (noteText === "") {
      hideLoadingSpinner();
      showAlertModal("Please enter a note!");
      return;
    }

    try {
      await db.collection("users").doc(currentUserId).collection("notes").add({
        text: noteText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Server timestamp for ordering
      });
      noteInput.value = ""; // Clear input field
      showAlertModal("Note added successfully!");
      // onSnapshot listener will handle UI update
    } catch (error) {
      console.error("Error adding note: ", error);
      showAlertModal("Failed to add note. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }

  // Allow adding a note by pressing Enter in the note input field
  noteInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      addNote();
    }
  });

  /**
   * Deletes a note from Firestore.
   * @param {string} id - The ID of the note document to delete.
   */
  async function deleteNote(id) {
    if (!currentUserId) return;
    showConfirmationModal("Are you sure you want to delete this note?", async (confirmed) => {
      if (confirmed) {
        showLoadingSpinner();
        try {
          await db.collection("users").doc(currentUserId).collection("notes").doc(id).delete(); // Delete document
          showAlertModal("Note deleted successfully!");
          // onSnapshot listener will handle UI update
        } catch (error) {
          console.error("Error removing note: ", error);
          showAlertModal("Failed to delete note. Please try again.");
        } finally {
          hideLoadingSpinner();
        }
      }
    });
  }

  /**
   * Renders a single note item into the DOM.
   * @param {Object} doc - Firestore document snapshot.
   */
  function renderNoteItem(doc) {
    const note = doc.data();
    const div = document.createElement("div"); // Create a div for each note
    div.id = `note-${doc.id}`; // Assign unique ID
    div.className = `bg-blue-50 dark:bg-gray-600 p-4 rounded-lg shadow-md flex justify-between items-start transition-all duration-200`;

    // Format timestamp for display, handling potential non-Timestamp values
    const timestampData = note.timestamp;
    const timestamp = (timestampData instanceof firebase.firestore.Timestamp) 
                      ? timestampData.toDate().toLocaleString() 
                      : (timestampData ? new Date(timestampData).toLocaleString() : 'N/A');

    div.innerHTML = `
      <div class="flex-1 mr-4">
        <p class="text-gray-800 dark:text-gray-100 text-lg flex-1 mr-4 break-words">${note.text}</p>
        <p class="text-sm text-gray-600 dark:text-gray-300 mt-2">Added: ${timestamp}</p>
      </div>
      <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-600 text-xl transition-colors duration-200" onclick="editNote('${doc.id}')" title="Edit Note">‚úèÔ∏è</button>
      <button class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600 text-xl transition-colors duration-200 ml-2" onclick="deleteNote('${doc.id}')" title="Delete Note">‚úñ</button>
    `;
    notesList.appendChild(div);
  }

  /**
   * Enables editing for a specific note, replacing its display with an input field.
   * @param {string} id - The ID of the note document in Firestore.
   */
  async function editNote(id) {
    if (!currentUserId) return;
    const noteRef = db.collection("users").doc(currentUserId).collection("notes").doc(id);
    try {
      const doc = await noteRef.get();
      if (!doc.exists) {
        showAlertModal("Note not found!");
        return;
      }
      const note = doc.data();

      const noteItem = document.getElementById(`note-${id}`);
      noteItem.innerHTML = `
        <div class="flex-1 flex flex-col gap-2 w-full">
          <textarea id="editNoteText-${id}" rows="4" 
                    class="flex-1 border border-gray-300 dark:border-gray-600 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500 text-lg dark:text-gray-100 w-full">${note.text}</textarea>
        </div>
        <div class="flex items-center space-x-3 mt-2 sm:mt-0">
          <button class='bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200' onclick='saveNote("${id}")'>Save</button>
          <button class='bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200' onclick='setupNotesRealtimeListener()'>Cancel</button>
        </div>
      `;
    } catch (error) {
      console.error("Error fetching note for edit: ", error);
      showAlertModal("Failed to load note for editing. Please try again.");
    }
  }

  /**
   * Saves the edited note to Firestore.
   * @param {string} id - The ID of the note document to update.
   */
  async function saveNote(id) {
    if (!currentUserId) return;
    showLoadingSpinner();
    const newText = document.getElementById(`editNoteText-${id}`).value.trim();

    if (newText === "") {
      hideLoadingSpinner();
      showAlertModal("Note text cannot be empty!");
      return;
    }

    try {
      await db.collection("users").doc(currentUserId).collection("notes").doc(id).update({
        text: newText
      });
      showAlertModal("Note updated successfully!");
      // onSnapshot listener will handle UI update
    } catch (error) {
      console.error("Error updating note: ", error);
      showAlertModal("Failed to update note. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }


  /**
   * Sets up a real-time listener for notes from Firestore.
   * This function will automatically update the UI whenever data changes in the 'notes' collection.
   */
  function setupNotesRealtimeListener() {
    if (!currentUserId) {
        notesList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your notes.</li>';
        totalNotesCount.innerText = '0';
        return;
    }
    db.collection("users").doc(currentUserId).collection("notes")
      // Removed .orderBy("timestamp", "desc") from Firestore query
      .onSnapshot((snapshot) => {
        showLoadingSpinner(); // Always show for a brief moment for visual feedback

        notesList.innerHTML = ''; // Clear existing list
        let notes = [];
        snapshot.forEach(doc => {
            const noteData = doc.data();
            const timestamp = (noteData.timestamp instanceof firebase.firestore.Timestamp) ? noteData.timestamp.toDate() : (noteData.timestamp ? new Date(noteData.timestamp) : new Date(0));
            notes.push({ ...noteData, id: doc.id, timestamp: timestamp });
        });

        // Client-side sort by timestamp (newest first)
        notes.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

        notes.forEach(note => {
          renderNoteItem({ id: note.id, data: () => note });
        });
        updateDashboardCounts(); // Update dashboard count after notes are rendered
        hideLoadingSpinner();
      }, (error) => {
        console.error("Error loading notes in real-time: ", error);
        showAlertModal("Failed to load notes in real-time. Please check your internet connection.");
        hideLoadingSpinner();
      });
  }


  // --- Mood Tracker Logic ---
  const moodLogMessage = document.getElementById("moodLogMessage");
  const moodHistoryList = document.getElementById("moodHistoryList");

  /**
   * Logs the user's mood to Firestore.
   * @param {string} mood - The mood string (e.g., 'happy', 'sad').
   */
  async function logMood(mood) {
    if (!currentUserId) {
        showAlertModal("Please log in to log your mood.");
        return;
    }
    showLoadingSpinner();
    try {
      await db.collection("users").doc(currentUserId).collection("moods").add({
        mood: mood,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      moodLogMessage.innerText = `Logged your mood as: ${getMoodEmoji(mood)} ${capitalizeFirstLetter(mood)}!`;
      showAlertModal(`Mood "${capitalizeFirstLetter(mood)}" logged successfully!`);
      loadMoodHistory(); // Reload mood history after logging
    } catch (error) {
      console.error("Error logging mood: ", error);
      showAlertModal("Failed to log mood. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }

  /** Loads and displays recent mood history from Firestore. */
  async function loadMoodHistory() {
    if (!currentUserId) {
        moodHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">Please log in to see your mood history.</li>';
        return;
    }
    moodHistoryList.innerHTML = ''; // Clear previous history
    try {
      // Removed .orderBy("timestamp", "desc") from Firestore query
      const snapshot = await db.collection("users").doc(currentUserId).collection("moods").limit(7).get();
      let moods = [];
      snapshot.forEach(doc => {
        const moodData = doc.data();
        const timestamp = (moodData.timestamp instanceof firebase.firestore.Timestamp) ? moodData.timestamp.toDate() : (moodData.timestamp ? new Date(moodData.timestamp) : new Date(0));
        moods.push({ ...moodData, id: doc.id, timestamp: timestamp });
      });

      // Client-side sort by timestamp (newest first)
      moods.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

      if (moods.length === 0) {
        moodHistoryList.innerHTML = '<li class="text-gray-600 dark:text-gray-300 text-center py-2">No moods logged yet.</li>';
        return;
      }
      moods.forEach(moodData => {
        const li = document.createElement("li");
        li.className = "p-2 bg-gray-50 dark:bg-gray-600 rounded-md shadow-sm text-gray-700 dark:text-gray-200 flex justify-between items-center";
        li.innerHTML = `
            <span>${getMoodEmoji(moodData.mood)} ${capitalizeFirstLetter(moodData.mood)}</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">${moodData.timestamp.toLocaleDateString()}</span>
        `;
        moodHistoryList.appendChild(li);
      });
    } catch (error) {
      console.error("Error loading mood history: ", error);
      showAlertModal("Failed to load mood history.");
    } finally {
      hideLoadingSpinner(); // Ensure spinner is hidden
    }
  }

  /** Helper to get emoji for a given mood string. */
  function getMoodEmoji(mood) {
      switch (mood) {
          case 'happy': return 'üòÑ';
          case 'neutral': return 'üòê';
          case 'sad': return 'üòû';
          case 'stressed': return ' ';
          default: return '';
      }
  }

  /** Helper to capitalize the first letter of a string. */
  function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
  }


  // --- Today's Focus Logic ---
  const todayFocusInput = document.getElementById("todayFocusInput");
  const setFocusBtn = document.getElementById("setFocusBtn");
  const clearFocusBtn = document.getElementById("clearFocusBtn");
  const currentFocusDisplay = document.getElementById("currentFocusDisplay");

  /** Sets today's focus in Firestore. */
  async function setTodayFocus() {
    if (!currentUserId) {
        showAlertModal("Please log in to set today's focus.");
        return;
    }
    showLoadingSpinner();
    const focusText = todayFocusInput.value.trim();
    if (focusText === "") {
      hideLoadingSpinner();
      showAlertModal("Please enter your focus for today!");
      return;
    }

    try {
      // Use today's date as the document ID for daily focus
      const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
      await db.collection("users").doc(currentUserId).collection("dailyFocus").doc(today).set({
        focus: focusText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      showAlertModal("Today's focus set!");
      loadTodayFocus(); // Update display immediately
    } catch (error) {
      console.error("Error setting daily focus: ", error);
      showAlertModal("Failed to set today's focus. Please try again.");
    } finally {
      hideLoadingSpinner();
    }
  }

  /** Clears today's focus from Firestore. */
  async function clearTodayFocus() {
    if (!currentUserId) return;
    showConfirmationModal("Are you sure you want to clear today's focus?", async (confirmed) => {
      if (confirmed) {
        showLoadingSpinner();
        try {
          const today = new Date().toISOString().split('T')[0];
          await db.collection("users").doc(currentUserId).collection("dailyFocus").doc(today).delete(); // Delete the document
          showAlertModal("Today's focus cleared!");
          loadTodayFocus(); // Clear display
        } catch (error) {
          console.error("Error clearing daily focus: ", error);
          showAlertModal("Failed to clear today's focus. Please try again.");
        } finally {
          hideLoadingSpinner();
        }
      }
    });
  }

  /** Loads and displays today's focus from Firestore. */
  async function loadTodayFocus() {
    if (!currentUserId) {
        currentFocusDisplay.innerText = "Please log in to set your focus.";
        todayFocusInput.value = "";
        setFocusBtn.classList.remove('hidden');
        clearFocusBtn.classList.add('hidden');
        return;
    }
    const today = new Date().toISOString().split('T')[0];
    try {
      const doc = await db.collection("users").doc(currentUserId).collection("dailyFocus").doc(today).get(); // Fetch today's focus
      if (doc.exists && doc.data().focus) {
        currentFocusDisplay.innerText = `Focus: "${doc.data().focus}"`;
        todayFocusInput.value = doc.data().focus; // Populate input with current focus
        setFocusBtn.classList.add('hidden'); // Hide set button
        clearFocusBtn.classList.remove('hidden'); // Show clear button
      } else {
        currentFocusDisplay.innerText = "No focus set for today. Set one above!";
        todayFocusInput.value = "";
        setFocusBtn.classList.remove('hidden'); // Show set button
        clearFocusBtn.classList.add('hidden'); // Hide clear button
      }
    } catch (error) {
      console.error("Error loading daily focus: ", error);
      currentFocusDisplay.innerText = "Error loading today's focus.";
    } finally {
      hideLoadingSpinner(); // Ensure spinner is hidden
    }
  }


  // --- Dashboard Counts Update ---
  /** Updates the counts displayed on the Home dashboard section. */
  async function updateDashboardCounts() {
    if (!currentUserId) {
        tasksTodayCount.innerText = '0';
        totalNotesCount.innerText = '0';
        pomodoroCompletedCountDisplay.innerText = '0';
        return;
    }
    try {
      const today = new Date();
      // Format today's date to YYYY-MM-DD for comparison with dueDate
      const todayDateString = today.toISOString().split('T')[0];

      // Count tasks due today and not completed
      const tasksTodaySnapshot = await db.collection("users").doc(currentUserId).collection("todos")
                                         .where("dueDate", "==", todayDateString)
                                         .where("completed", "==", false)
                                         .get();
      tasksTodayCount.innerText = tasksTodaySnapshot.size; // Update dashboard count

      // Count total notes
      const notesSnapshot = await db.collection("users").doc(currentUserId).collection("notes").get();
      totalNotesCount.innerText = notesSnapshot.size; // Update dashboard count

      // Pomodoro count is handled by loadPomodoroHistory, which updates pomodoroCompletedCountDisplay.

    } catch (error) {
      console.error("Error updating dashboard counts: ", error);
    }
  }


  // --- Data Export/Import ---
  async function exportUserData() {
    if (!currentUserId) {
        showAlertModal("Please log in to export your data.");
        return;
    }
    showLoadingSpinner();
    try {
        const userData = {};
        
        // Fetch Todos
        // Removed .orderBy from data export queries
        const todosSnapshot = await db.collection("users").doc(currentUserId).collection("todos").get();
        userData.todos = todosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Notes
        const notesSnapshot = await db.collection("users").doc(currentUserId).collection("notes").get();
        userData.notes = notesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Moods
        const moodsSnapshot = await db.collection("users").doc(currentUserId).collection("moods").get();
        userData.moods = moodsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Daily Focus
        const dailyFocusSnapshot = await db.collection("users").doc(currentUserId).collection("dailyFocus").get();
        userData.dailyFocus = dailyFocusSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Pomodoro Sessions
        const pomodoroSnapshot = await db.collection("users").doc(currentUserId).collection("pomodoroSessions").get();
        userData.pomodoroSessions = pomodoroSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const dataStr = JSON.stringify(userData, null, 2); // Pretty print JSON
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `schedule_planner_data_${currentUserId}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showAlertModal("Data exported successfully!");
    } catch (error) {
        console.error("Error exporting data:", error);
        showAlertModal(`Failed to export data: ${error.message}`);
    } finally {
        hideLoadingSpinner();
    }
  }

  async function importUserData(event) {
    if (!currentUserId) {
        showAlertModal("Please log in to import data.");
        return;
    }
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    showLoadingSpinner();
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const importedData = JSON.parse(e.target.result);

            showConfirmationModal("Importing data will overwrite existing data. Proceed?", async (confirmed) => {
                if (confirmed) {
                    // Clear existing data before importing (optional, but safer)
                    await clearCollection(`users/${currentUserId}/todos`);
                    await clearCollection(`users/${currentUserId}/notes`);
                    await clearCollection(`users/${currentUserId}/moods`);
                    await clearCollection(`users/${currentUserId}/dailyFocus`);
                    await clearCollection(`users/${currentUserId}/pomodoroSessions`);

                    // Import each collection
                    await importCollectionData('todos', importedData.todos);
                    await importCollectionData('notes', importedData.notes);
                    await importCollectionData('moods', importedData.moods);
                    await importCollectionData('dailyFocus', importedData.dailyFocus, true); // For dailyFocus, use ID
                    await importCollectionData('pomodoroSessions', importedData.pomodoroSessions);

                    showAlertModal("Data imported successfully!");
                    // Re-load all data after import
                    setupTodoRealtimeListener();
                    setupNotesRealtimeListener();
                    loadMoodHistory();
                    loadTodayFocus();
                } else {
                    showAlertModal("Data import cancelled.");
                }
            });
        } catch (error) {
            console.error("Error importing data:", error);
            showAlertModal(`Failed to import data. Please ensure it's a valid JSON file: ${error.message}`);
        } finally {
            hideLoadingSpinner();
        }
    };
    reader.readAsText(file);
    // Clear the file input value so same file can be selected again if needed
    event.target.value = null;
  }

  async function clearCollection(path) {
      const snapshot = await db.collection(path).get();
      const batch = db.batch();
      snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
      });
      await batch.commit();
      console.log(`Collection ${path} cleared.`);
  }

  async function importCollectionData(collectionName, data, useIdAsDocId = false) {
      if (!data || !Array.isArray(data)) return;
      const batch = db.batch();
      data.forEach(item => {
          const { id, ...rest } = item;
          // Convert timestamp fields back to Firestore Timestamp objects if they were stringified Date objects
          if (rest.timestamp && typeof rest.timestamp === 'string') {
            try {
              rest.timestamp = firebase.firestore.Timestamp.fromDate(new Date(rest.timestamp));
            } catch (e) {
              console.warn(`Could not convert timestamp for item ${id}:`, rest.timestamp, e);
            }
          }
          if (useIdAsDocId && id) {
              batch.set(db.collection("users").doc(currentUserId).collection(collectionName).doc(id), rest);
          } else {
              batch.add(db.collection("users").doc(currentUserId).collection(collectionName), rest);
          }
      });
      await batch.commit();
      console.log(`Imported ${data.length} items into ${collectionName}.`);
  }

  // --- Browser Notifications ---
  function requestNotificationPermission() {
    if ("Notification" in window) {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("Notification permission granted.");
        } else {
          console.warn("Notification permission denied.");
        }
      });
    }
  }

  function triggerNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(title, { body: body, icon: 'üìÖ' }); // Using emoji as icon
    }
  }


  // --- Initial Data Load and Realtime Listeners on DOM Content Loaded ---
  document.addEventListener("DOMContentLoaded", () => {
    // Show spinner immediately when the page starts loading
    showLoadingSpinner();

    // Apply saved theme preference
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
    }
    // The rest of the initial setup (Firebase auth and data loading) will be handled
    // by the `auth.onAuthStateChanged` listener, which will hide the spinner
    // once the auth state is resolved and data listeners are set up.
  });
</script>
</body>
</html>
 